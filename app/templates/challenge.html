{% extends wrapper_template %}

{% block head_extra %}
    <!-- Turnstile script -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
{% endblock %}

{% block page_styles %}
    #verify-btn {
        color: #EBE6F0;
        background-color: #46166B;
        border-color: #46166B;
    }
    /* Hover style when disabled */
    #verify-btn:disabled:hover {
        color: #EBE6F0;
        background-color: #46166B;
        border-color: #46166B;
        cursor: not-allowed;
    }

    /* Hover style when enabled */
    #verify-btn:hover:not(:disabled) {
        background-color: #eaaa00;
        border-color: #eaaa00;
        cursor: pointer;
    }
    #redirect-spinner .spinner-border {
      width: 3rem;
      height: 3rem;
    }
{% endblock %}

{% block content %}
<div class="row">
    <div class="container main-container">
        <div id="contentColumn" class="col-md-12">

            <h1>Are you Human?</h1>

            <p class="mt-3">This quick check helps us prevent bots from overloading our site, keeping it available for everyone.</p>
            <p class="mb-4">The verification should only take a moment and will automatically redirect you once it is complete.</p>

            <form method="POST" class="mt-4" id="verify-form">
              <div class="form-group">
                <div class="cf-turnstile mb-3"
                     data-sitekey="{{ sitekey }}"
                     data-callback="turnstileCallback"
                     data-expired-callback="turnstileExpired"
                     data-error-callback="turnstileError"></div>

                <input type="hidden" name="cf-turnstile-response" id="cf-turnstile-response">
                <input type="hidden" name="next" value="{{ next_url }}">
              </div>
            </form>

            <div id="redirect-spinner" class="text-center mt-4" style="display: none;">
              <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
              <p class="mt-3">Verification complete. Redirectingâ€¦</p>
            </div>

            <script>
              function turnstileCallback(token) {
                const form = document.getElementById('verify-form');
                document.getElementById('cf-turnstile-response').value = token;

                // Show spinner
                document.getElementById('redirect-spinner').style.display = 'block';
                form.style.display = 'none';

                // Submit the form
                form.submit();
              }

              function turnstileExpired() {
                document.getElementById('cf-turnstile-response').value = '';
              }

              function turnstileError() {
                document.getElementById('cf-turnstile-response').value = '';
              }
            </script>

        </div>
    </div>
</div>
{% endblock %}